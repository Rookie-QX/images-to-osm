# 卫星图像到OSM
本项目使用Mask R-CNN算法来检测卫星图像中的特征。目标是测试Mask R-CNN神经网络算法，并通过向地图添加高质量的棒球场、足球场、网球场、美式足球场和篮球场来改进OpenStreetMap。

[Mask R-CNN](https://arxiv.org/abs/1703.06870)于2017年3月由[Facebook AI研究院(FAIR)](https://research.fb.com/category/facebook-ai-research-fair/)发布。

这篇论文声称在检测实例分割掩码方面达到了最先进的性能。这一论文结果令人兴奋，因为"解决"实例分割掩码问题将使Facebook和OpenStreetMap之外的许多实际应用受益。

在新数据集上成功使用Mask R-CNN将是该算法足够通用并适用于许多问题的良好指标。然而，公开可用的数据集中，具有足够图像来训练此算法的数量有限，因为收集和注释50,000多张图像的数据既昂贵又耗时。

微软的Bing卫星图像，结合OpenStreetMap数据，是分割掩码数据的良好来源。有机会使用前沿AI算法并从事我最喜欢的爱好(OSM)，这个机会实在太好了，无法错过。

## 示例图像

Mask R-CNN在Bing图像中找到棒球场、篮球场和网球场。

![OSM Mask R-CNN示例1](/sample-images/sample1.png)
![OSM Mask R-CNN示例2](/sample-images/sample2.png)
![OSM Mask R-CNN示例3](/sample-images/sample3.png)

## Mask R-CNN实现

在当前时间(2017年底)，Facebook AI研究院尚未发布他们的实现。[Matterport, Inc](https://matterport.com/)已慷慨地在github上发布了一个非常好的使用Keras和TensorFlow的[Mask R-CNN实现](https://github.com/matterport/Mask_RCNN)。本项目基于Matterport, Inc的工作。

## 为什么选择运动场

运动场非常适合Mask R-CNN算法。

- 无论树木覆盖如何，它们都在卫星图像中可见，这与建筑物不同。
- 它们是"斑点"形状而非线形状，如道路。
- 如果成功，它们易于合并并导入回OSM，因为它们是孤立的特征。

## 使用OSM进行训练

这个项目的延伸目标是训练一个达到人类级别性能的神经网络，并在OSM中完全绘制马萨诸塞州的运动场。不幸的是，OSM中现有的数据质量不足以训练任何算法达到人类级别的性能。计划是迭代训练，将修正反馈给OSM，然后重新训练，同时提升算法和OSM。希望OSM和算法之间能形成良性循环，直到算法变得与人类测绘者一样好。

## 工作流程

训练工作流程在trainall.py中，它按顺序调用以下脚本。

1. getdatafromosm.py使用overpass下载运动场的数据。
2. gettilesfrombing.py使用OSM数据下载所需的Bing图块。该脚本下载速度较慢，首次运行预计需要约2天时间。
3. maketrainingimages.py收集OSM数据和Bing图块，生成一组训练图像和掩码。每次运行预计需要12小时。
4. train.py实际运行Mask R-CNN算法的训练。在单个8GB内存的GTX 1080上运行预计需要4天时间。

## 将结果转换为OSM文件

5. createosmanomaly.py在训练图像集上运行神经网络并建议对OSM进行更改。

   此脚本将神经网络输出掩码转换为候选OSM路径。它通过将完美矩形拟合到网球场和篮球场掩码边界来实现这一点。对于棒球场，OSM路径是拟合的90度楔形和简化的掩码边界。掩码拟合是一个非线性优化问题，它使用simplex优化器和robust Huber成本函数执行。使用simplex优化器是因为我懒得编写偏导数函数。被拟合的边界不是高斯过程，因此Huber成本函数比标准最小二乘成本函数更好。特征的未知旋转导致拟合优化高度非凸。用通俗的话说，如果优化从最优解较远的地方开始，则会陷入局部谷底。这通过简单地在几个旋转处为优化器种子并输出所有高质量拟合来处理。使用reviewosmanomaly.py脚本的人类会排序出哪个旋转是正确的。希望随着神经网络在棒球场上的性能提高，可以移除这些替代旋转。

   为了达到延伸目标，OSM的训练数据需要非常完美。脚本需要扩展以识别错误标记的场地和描绘不良的场地。目前，它只是识别OSM中缺失的场地。

6. 接下来运行reviewosmanomaly.py来视觉上批准或拒绝异常目录中建议的更改。

    注意这是唯一需要用户交互的脚本。该脚本将createosmanomaly.py的建议聚集在一起并呈现一个选项库。然后用户视觉检查图像库并批准或拒绝createosmanomaly.py建议的更改。显示的图像是Bing卫星图像上的最终路径几何形状。

7. createfinalosm.py从reviewosmanomaly.py完成的异常审查创建最终的.osm文件。它将文件分解，使最终OSM文件大小低于OSM API的10,000个元素限制。

## 第1阶段 - 注释 ##

项目的第1阶段是直接利用未改进的OSM数据训练神经网络，并[导入缺失的场地](https://wiki.openstreetmap.org/wiki/US_Sports_Fields_Import_2018)从训练图像回到OSM。大约2,800个缺失的场地被识别出来，并将很快导入回OSM。

对于网球场和篮球场，性能相当好。掩码是矩形，几乎没有误报。就像人类测绘者一样，它可以轻松处理网球场和篮球场的集群、旋转、树木遮挡和不同颜色的路面。它接近但尚未完全达到人类水平的性能。在缺失的场地导入到OSM后，希望它能达到人类水平的性能。

好消息/坏消息是棒球场。它们比网球场和篮球场更具挑战性和趣味性。首先，它们在规模上有很大的变化。幼儿用的棒球场比成人用的标准场地小5到6倍。识别棒球场的主要特征是内场钻石，但内场只是实际完整棒球场的一小部分。要绘制棒球场，必须包括大片无特征的草地外场。外场必须从内场推断出来。在有外场围栏的情况下，神经网络在围栏处终止外场方面做得很好。但大多数棒球场没有外场围栏甚至没有彩绘线。外场向外延伸，直到它们"碰到"其他东西，如树线、道路或其他场地，同时保持其楔形。使情况更复杂的是，像神经网络一样，OSM人类测绘者对于如何绘制没有围栏的外场也感到困惑！约10%的已绘制棒球场只有内场。

第1阶段的神经网络在识别内场方面没有问题，但它在处理没有围栏的棒球外场方面存在困难。在2,800个已识别的场地中，只包括了具有出色外场的棒球场。由于外场性能不佳，许多缺失的棒球场不得不被跳过。希望导入OSM的额外高质量外场数据能在下一阶段改进它在这个具有挑战性领域的性能。

![棒球外场问题](/sample-images/phase1-baseball-outfieds.png)

## 配置

- Ubuntu 17.10
- Bing密钥，创建一个secrets.py文件，添加bingKey ="你的密钥"
- 创建一个Python 3.6虚拟环境
- 在虚拟环境中，运行"pip install -r requirements.txt"
- TensorFlow 1.3+
- Keras 2.0.8+.

